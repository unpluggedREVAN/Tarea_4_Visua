<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treemap Squarify with D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node {
            border: solid 1px white;
            font: 10px sans-serif;
            line-height: 12px;
            overflow: hidden;
            position: absolute;
            text-align: center;
        }
    </style>
</head>
<body>
    <script>
        const width = 960;
        const height = 570;

        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const treemap = d3.treemap()
            .tile(d3.treemapSquarify)
            .size([width, height])
            .paddingInner(1)
            .round(true);

        function processCSVData(csvData) {
            const root = {
                name: "root",
                children: []
            };

            const map = new Map();

            csvData.forEach(row => {
                const id = row.id;
                const value = +row.value;
                const parts = id.split(".");

                let current = root;

                parts.forEach((part, index) => {
                    if (!map.has(part)) {
                        const newNode = {
                            name: part,
                            children: []
                        };
                        current.children.push(newNode);
                        map.set(part, newNode);
                    }

                    current = map.get(part);

                    if (index === parts.length - 1) {
                        current.value = value;
                        current.children = null;  // remove children for leaf nodes
                    }
                });
            });

            return d3.hierarchy(root)
                .sum(d => d.value)
                .sort((a, b) => b.height - a.height || b.value - a.value);
        }

        async function loadAndProcessData(url) {
            try {
                const dataCSV = await d3.csv(url);
                return processCSVData(dataCSV);
            } catch (error) {
                console.error("Error al cargar el CSV:", error);
            }
        }

        async function drawTreemap(url) {
            const root = await loadAndProcessData(url);

            treemap(root);

            const svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("font-family", "sans-serif");

            const node = svg.selectAll(".node")
                .data(root.leaves())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            node.append("rect")
                .attr("id", d => d.data.name)
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => color(d.parent.data.name));

            node.append("clipPath")
                .attr("id", d => `clip-${d.data.name}`)
                .append("use")
                .attr("xlink:href", d => `#${d.data.name}`);

            node.append("text")
                .attr("clip-path", d => `url(#clip-${d.data.name})`)
                .selectAll("tspan")
                .data(d => d.data.name.split(/(?=[A-Z][^A-Z])/g))
                .enter().append("tspan")
                .attr("x", 3)
                .attr("y", (d, i) => 13 + i * 10)
                .text(d => d);

            node.append("title")
                .text(d => `${d.data.name}\n${d.value}`);
        }

        drawTreemap("https://raw.githubusercontent.com/unpluggedREVAN/Tarea_4_Visua/main/flare.json");
    </script>
</body>
</html>
